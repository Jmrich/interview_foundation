<?php

namespace Tests\Feature;

use App\Services\GithubApiService;
use App\User;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Tests\TestCase;

class GithubControllerTest extends TestCase
{
    use RefreshDatabase;

    public function testCanSaveGithubToken()
    {
        $user = factory(User::class)->create();

        $token = 'token-value';

        $response = $this->actingAs($user)->putJson(route('github.token.update'), [
            'token' => $token
        ]);

        $this->assertEquals($token, $user->fresh()->github_token);
    }

    public function testCanGetStarredRepos()
    {
        $mock = $this->mock(GithubApiService::class);

        $mock->shouldReceive('getStarredRepos')->andReturn(json_decode($this->getMockedResponse(), true));

        $user = factory(User::class)->create([
            'github_token' => 'valid-token'
        ]);

        $response = $this->actingAs($user)->getJson(route('github.starred-repos'));

        $response->assertJsonStructure([
            'data' => [
                '*' => [
                    'name',
                    'url'
                ]
            ]
        ]);
    }

    private function getMockedResponse()
    {
        return '[{"id":294529127,"node_id":"MDEwOlJlcG9zaXRvcnkyOTQ1MjkxMjc=","name":"interview_foundation","full_name":"Jmrich\/interview_foundation","private":false,"owner":{"login":"Jmrich","id":12086985,"node_id":"MDQ6VXNlcjEyMDg2OTg1","avatar_url":"https:\/\/avatars3.githubusercontent.com\/u\/12086985?v=4","gravatar_id":"","url":"https:\/\/api.github.com\/users\/Jmrich","html_url":"https:\/\/github.com\/Jmrich","followers_url":"https:\/\/api.github.com\/users\/Jmrich\/followers","following_url":"https:\/\/api.github.com\/users\/Jmrich\/following{\/other_user}","gists_url":"https:\/\/api.github.com\/users\/Jmrich\/gists{\/gist_id}","starred_url":"https:\/\/api.github.com\/users\/Jmrich\/starred{\/owner}{\/repo}","subscriptions_url":"https:\/\/api.github.com\/users\/Jmrich\/subscriptions","organizations_url":"https:\/\/api.github.com\/users\/Jmrich\/orgs","repos_url":"https:\/\/api.github.com\/users\/Jmrich\/repos","events_url":"https:\/\/api.github.com\/users\/Jmrich\/events{\/privacy}","received_events_url":"https:\/\/api.github.com\/users\/Jmrich\/received_events","type":"User","site_admin":false},"html_url":"https:\/\/github.com\/Jmrich\/interview_foundation","description":"Foundation install for interview ","fork":true,"url":"https:\/\/api.github.com\/repos\/Jmrich\/interview_foundation","forks_url":"https:\/\/api.github.com\/repos\/Jmrich\/interview_foundation\/forks","keys_url":"https:\/\/api.github.com\/repos\/Jmrich\/interview_foundation\/keys{\/key_id}","collaborators_url":"https:\/\/api.github.com\/repos\/Jmrich\/interview_foundation\/collaborators{\/collaborator}","teams_url":"https:\/\/api.github.com\/repos\/Jmrich\/interview_foundation\/teams","hooks_url":"https:\/\/api.github.com\/repos\/Jmrich\/interview_foundation\/hooks","issue_events_url":"https:\/\/api.github.com\/repos\/Jmrich\/interview_foundation\/issues\/events{\/number}","events_url":"https:\/\/api.github.com\/repos\/Jmrich\/interview_foundation\/events","assignees_url":"https:\/\/api.github.com\/repos\/Jmrich\/interview_foundation\/assignees{\/user}","branches_url":"https:\/\/api.github.com\/repos\/Jmrich\/interview_foundation\/branches{\/branch}","tags_url":"https:\/\/api.github.com\/repos\/Jmrich\/interview_foundation\/tags","blobs_url":"https:\/\/api.github.com\/repos\/Jmrich\/interview_foundation\/git\/blobs{\/sha}","git_tags_url":"https:\/\/api.github.com\/repos\/Jmrich\/interview_foundation\/git\/tags{\/sha}","git_refs_url":"https:\/\/api.github.com\/repos\/Jmrich\/interview_foundation\/git\/refs{\/sha}","trees_url":"https:\/\/api.github.com\/repos\/Jmrich\/interview_foundation\/git\/trees{\/sha}","statuses_url":"https:\/\/api.github.com\/repos\/Jmrich\/interview_foundation\/statuses\/{sha}","languages_url":"https:\/\/api.github.com\/repos\/Jmrich\/interview_foundation\/languages","stargazers_url":"https:\/\/api.github.com\/repos\/Jmrich\/interview_foundation\/stargazers","contributors_url":"https:\/\/api.github.com\/repos\/Jmrich\/interview_foundation\/contributors","subscribers_url":"https:\/\/api.github.com\/repos\/Jmrich\/interview_foundation\/subscribers","subscription_url":"https:\/\/api.github.com\/repos\/Jmrich\/interview_foundation\/subscription","commits_url":"https:\/\/api.github.com\/repos\/Jmrich\/interview_foundation\/commits{\/sha}","git_commits_url":"https:\/\/api.github.com\/repos\/Jmrich\/interview_foundation\/git\/commits{\/sha}","comments_url":"https:\/\/api.github.com\/repos\/Jmrich\/interview_foundation\/comments{\/number}","issue_comment_url":"https:\/\/api.github.com\/repos\/Jmrich\/interview_foundation\/issues\/comments{\/number}","contents_url":"https:\/\/api.github.com\/repos\/Jmrich\/interview_foundation\/contents\/{+path}","compare_url":"https:\/\/api.github.com\/repos\/Jmrich\/interview_foundation\/compare\/{base}...{head}","merges_url":"https:\/\/api.github.com\/repos\/Jmrich\/interview_foundation\/merges","archive_url":"https:\/\/api.github.com\/repos\/Jmrich\/interview_foundation\/{archive_format}{\/ref}","downloads_url":"https:\/\/api.github.com\/repos\/Jmrich\/interview_foundation\/downloads","issues_url":"https:\/\/api.github.com\/repos\/Jmrich\/interview_foundation\/issues{\/number}","pulls_url":"https:\/\/api.github.com\/repos\/Jmrich\/interview_foundation\/pulls{\/number}","milestones_url":"https:\/\/api.github.com\/repos\/Jmrich\/interview_foundation\/milestones{\/number}","notifications_url":"https:\/\/api.github.com\/repos\/Jmrich\/interview_foundation\/notifications{?since,all,participating}","labels_url":"https:\/\/api.github.com\/repos\/Jmrich\/interview_foundation\/labels{\/name}","releases_url":"https:\/\/api.github.com\/repos\/Jmrich\/interview_foundation\/releases{\/id}","deployments_url":"https:\/\/api.github.com\/repos\/Jmrich\/interview_foundation\/deployments","created_at":"2020-09-10T21:43:46Z","updated_at":"2020-09-10T23:50:02Z","pushed_at":"2020-09-10T23:35:25Z","git_url":"git:\/\/github.com\/Jmrich\/interview_foundation.git","ssh_url":"git@github.com:Jmrich\/interview_foundation.git","clone_url":"https:\/\/github.com\/Jmrich\/interview_foundation.git","svn_url":"https:\/\/github.com\/Jmrich\/interview_foundation","homepage":null,"size":577,"stargazers_count":1,"watchers_count":1,"language":"PHP","has_issues":false,"has_projects":true,"has_downloads":true,"has_wiki":true,"has_pages":false,"forks_count":0,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":0,"license":null,"forks":0,"open_issues":0,"watchers":1,"default_branch":"develop","permissions":{"admin":true,"push":true,"pull":true}},{"id":81001471,"node_id":"MDEwOlJlcG9zaXRvcnk4MTAwMTQ3MQ==","name":"countries","full_name":"antonioribeiro\/countries","private":false,"owner":{"login":"antonioribeiro","id":3182864,"node_id":"MDQ6VXNlcjMxODI4NjQ=","avatar_url":"https:\/\/avatars3.githubusercontent.com\/u\/3182864?v=4","gravatar_id":"","url":"https:\/\/api.github.com\/users\/antonioribeiro","html_url":"https:\/\/github.com\/antonioribeiro","followers_url":"https:\/\/api.github.com\/users\/antonioribeiro\/followers","following_url":"https:\/\/api.github.com\/users\/antonioribeiro\/following{\/other_user}","gists_url":"https:\/\/api.github.com\/users\/antonioribeiro\/gists{\/gist_id}","starred_url":"https:\/\/api.github.com\/users\/antonioribeiro\/starred{\/owner}{\/repo}","subscriptions_url":"https:\/\/api.github.com\/users\/antonioribeiro\/subscriptions","organizations_url":"https:\/\/api.github.com\/users\/antonioribeiro\/orgs","repos_url":"https:\/\/api.github.com\/users\/antonioribeiro\/repos","events_url":"https:\/\/api.github.com\/users\/antonioribeiro\/events{\/privacy}","received_events_url":"https:\/\/api.github.com\/users\/antonioribeiro\/received_events","type":"User","site_admin":false},"html_url":"https:\/\/github.com\/antonioribeiro\/countries","description":"Laravel countries and currencies","fork":false,"url":"https:\/\/api.github.com\/repos\/antonioribeiro\/countries","forks_url":"https:\/\/api.github.com\/repos\/antonioribeiro\/countries\/forks","keys_url":"https:\/\/api.github.com\/repos\/antonioribeiro\/countries\/keys{\/key_id}","collaborators_url":"https:\/\/api.github.com\/repos\/antonioribeiro\/countries\/collaborators{\/collaborator}","teams_url":"https:\/\/api.github.com\/repos\/antonioribeiro\/countries\/teams","hooks_url":"https:\/\/api.github.com\/repos\/antonioribeiro\/countries\/hooks","issue_events_url":"https:\/\/api.github.com\/repos\/antonioribeiro\/countries\/issues\/events{\/number}","events_url":"https:\/\/api.github.com\/repos\/antonioribeiro\/countries\/events","assignees_url":"https:\/\/api.github.com\/repos\/antonioribeiro\/countries\/assignees{\/user}","branches_url":"https:\/\/api.github.com\/repos\/antonioribeiro\/countries\/branches{\/branch}","tags_url":"https:\/\/api.github.com\/repos\/antonioribeiro\/countries\/tags","blobs_url":"https:\/\/api.github.com\/repos\/antonioribeiro\/countries\/git\/blobs{\/sha}","git_tags_url":"https:\/\/api.github.com\/repos\/antonioribeiro\/countries\/git\/tags{\/sha}","git_refs_url":"https:\/\/api.github.com\/repos\/antonioribeiro\/countries\/git\/refs{\/sha}","trees_url":"https:\/\/api.github.com\/repos\/antonioribeiro\/countries\/git\/trees{\/sha}","statuses_url":"https:\/\/api.github.com\/repos\/antonioribeiro\/countries\/statuses\/{sha}","languages_url":"https:\/\/api.github.com\/repos\/antonioribeiro\/countries\/languages","stargazers_url":"https:\/\/api.github.com\/repos\/antonioribeiro\/countries\/stargazers","contributors_url":"https:\/\/api.github.com\/repos\/antonioribeiro\/countries\/contributors","subscribers_url":"https:\/\/api.github.com\/repos\/antonioribeiro\/countries\/subscribers","subscription_url":"https:\/\/api.github.com\/repos\/antonioribeiro\/countries\/subscription","commits_url":"https:\/\/api.github.com\/repos\/antonioribeiro\/countries\/commits{\/sha}","git_commits_url":"https:\/\/api.github.com\/repos\/antonioribeiro\/countries\/git\/commits{\/sha}","comments_url":"https:\/\/api.github.com\/repos\/antonioribeiro\/countries\/comments{\/number}","issue_comment_url":"https:\/\/api.github.com\/repos\/antonioribeiro\/countries\/issues\/comments{\/number}","contents_url":"https:\/\/api.github.com\/repos\/antonioribeiro\/countries\/contents\/{+path}","compare_url":"https:\/\/api.github.com\/repos\/antonioribeiro\/countries\/compare\/{base}...{head}","merges_url":"https:\/\/api.github.com\/repos\/antonioribeiro\/countries\/merges","archive_url":"https:\/\/api.github.com\/repos\/antonioribeiro\/countries\/{archive_format}{\/ref}","downloads_url":"https:\/\/api.github.com\/repos\/antonioribeiro\/countries\/downloads","issues_url":"https:\/\/api.github.com\/repos\/antonioribeiro\/countries\/issues{\/number}","pulls_url":"https:\/\/api.github.com\/repos\/antonioribeiro\/countries\/pulls{\/number}","milestones_url":"https:\/\/api.github.com\/repos\/antonioribeiro\/countries\/milestones{\/number}","notifications_url":"https:\/\/api.github.com\/repos\/antonioribeiro\/countries\/notifications{?since,all,participating}","labels_url":"https:\/\/api.github.com\/repos\/antonioribeiro\/countries\/labels{\/name}","releases_url":"https:\/\/api.github.com\/repos\/antonioribeiro\/countries\/releases{\/id}","deployments_url":"https:\/\/api.github.com\/repos\/antonioribeiro\/countries\/deployments","created_at":"2017-02-05T15:24:37Z","updated_at":"2020-09-09T16:16:06Z","pushed_at":"2020-06-10T15:51:03Z","git_url":"git:\/\/github.com\/antonioribeiro\/countries.git","ssh_url":"git@github.com:antonioribeiro\/countries.git","clone_url":"https:\/\/github.com\/antonioribeiro\/countries.git","svn_url":"https:\/\/github.com\/antonioribeiro\/countries","homepage":null,"size":70589,"stargazers_count":1380,"watchers_count":1380,"language":"PHP","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":true,"has_pages":false,"forks_count":167,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":58,"license":{"key":"bsd-3-clause","name":"BSD 3-Clause \"New\" or \"Revised\" License","spdx_id":"BSD-3-Clause","url":"https:\/\/api.github.com\/licenses\/bsd-3-clause","node_id":"MDc6TGljZW5zZTU="},"forks":167,"open_issues":58,"watchers":1380,"default_branch":"master","permissions":{"admin":false,"push":false,"pull":true}}]';
    }
}
